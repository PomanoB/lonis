<?phpinclude 'lightopenid.php';$openid = new LightOpenID;if (isset($_SESSION["user_$cookieKey"])) {	header('Location: ' . $baseUrl. '/ucp');}else {	if (isset($_SESSION["steamId64"])) {		$smarty->assign('steamId64', $_SESSION["steamId64"]);		$smarty->assign('steamName', $_SESSION["steamName"]);				if (!empty($_POST["reg_nick"]) && ($nick = trim($_POST["reg_nick"])))		{			$steamID = GetAuthID($_SESSION["steamId64"]);						if (!get_magic_quotes_gpc())				$nick = addslashes($nick);						$q = "INSERT INTO `unr_players` SET `name`= '{$nick}', `flags` = 2, `auth` = 1, `steam_id` = '{$steamID}', `active` = 1, `steam_id_64` = '{$_SESSION["steamId64"]}'";			if (mysql_query($q)) {				$_SESSION["user_$cookieKey"]["id"] = mysql_insert_id();				unset($_SESSION["steamId64"]);				header('Location: ' . $baseUrl. '/ucp');			}			else {				$smarty->assign('error', $langs["langAlreadyUsed"]);			}		}	}	else	if(!$openid->mode) {		$openid->identity = 'http://steamcommunity.com/openid';		header('Location: ' . $openid->authUrl());	}	else	if($openid->mode == 'cancel') {        header('Location: ' . $baseUrl);    }	else {        if ($openid->validate()) {			$steamId64 = explode('/', $openid->identity);					if (!get_magic_quotes_gpc())				$steamId64 = addslashes($steamId64[5]);			else				$steamId64 = $steamId64[5];						$steamId = GetAuthID($steamId64);						$r = mysql_query("SELECT `id` FROM `unr_players` WHERE `steam_id_64` = '{$steamId64}' OR `steam_id` = '{$steamId}' LIMIT 1");			if ($row = mysql_fetch_assoc($r)) {				$_SESSION["user_$cookieKey"]["id"] = $row["id"];				header('Location: ' . $baseUrl. '/ucp');			}			else {				$data = file_get_contents("http://steamcommunity.com/profiles/{$steamId64}/?xml=1");								$p1 = strpos($data, '<steamID><![CDATA[') + strlen('<steamID><![CDATA[');				$p2 = strpos($data, ']]></steamID>');				$steamName = substr($data, $p1, $p2 - $p1);								$_SESSION["steamId64"] = $steamId64;				$_SESSION["steamName"] = $steamName;								header('Location: ' . $baseUrl .'/steam_login');			}		}		else {			header('Location: ' . $baseUrl);		}    }	}function GetAuthID($i64friendID) {	$tmpfriendID = $i64friendID;	$iServer = "1";	if(bcmod($i64friendID, "2") == "0")	{		$iServer = "0";	}	$tmpfriendID = bcsub($tmpfriendID,$iServer);	if(bccomp("76561197960265728",$tmpfriendID) == -1)		$tmpfriendID = bcsub($tmpfriendID,"76561197960265728");	$tmpfriendID = bcdiv($tmpfriendID, "2");	return ("STEAM_0:" . $iServer . ":" . $tmpfriendID);}?>